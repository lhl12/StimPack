# StimPack
__Functions for processing and analyzing direct cortical stimulation data collected on the TDT, particularly for analysis of evoked potentials.__ Last edited: LL 01/07/2020

# Definitions
### pulse: 
an individual stimulation pulse (tested primarily on bipolar/biphasic pulses, but should be able to handle any).
### burst: 
a series of stimulation pulses delivered in sequence. These functions assume that anything 10 Hz or faster is a burst and anything slower than 10 Hz is a single-pulse trial.
### Sing: 
an output of all current (OpenEx, 01/2020) TDT protocols that involve stimulation. *Sing* is a record of when the TDT sends stimulation signals to the stim box, not of the stimulation output itself. For all tested protocols (DBS parameter sweep, sensory parameter sweep, sensory staircase, EP measure, EP screen, stim geometry), the stim impulses are recorded in channel one of Sing.data. *Will need to make alterations for functionality with paired pulse protocols.*


# FUNCTIONS
### getStimIndices(): Pulls relevant stimulation information from TDT output *Sing*.
#### REQUIRED INPUTS
* Sing: an output of the TDT that indicates when the TDT sent the signal to stimulate to the stim box - not a recording of the stimulation itself, but the software's output
#### OUTPUTS
* burst_limits: the index of the first and last point of each burst (a trials x 2 matrix)
* pulse_idx: the indices of each individual pulse within a burst (a trials x 1 cell array, each cell contains a pulses x 1 matrix, indexing is *not* within the burst but over the full time series)
* trial_voltage: the voltage of stimulation (in mV) for each trial (a trials x 1 matrix)
#### ASSUMPTIONS:
* stim does not occur at exactly 10V
* within-burst frequency is greater than 10Hz
* at least 100ms is allowed between trials
* only one stimulation voltage is used within a trial/burst
* relevant Sing info is in first column (true of DBS parameter sweep, sensory parameter sweep, sensory staircase, EP measure, EP screen, stim geometry)

### pullStimEpochs(): pulls epochs of identical size from provided data based on provided limits and trial starts
#### REQUIRED INPUTS:
* data: data to be split into epochs (a time x channels array)
* burst_limits: the start indices of each stimulation burst, as generated by getStimIndices(). Will ignore everything except the first column
* fsData: the sampling rate of data
* fsSing: the sampling rate of the Sing TDT output that was used to generate burst_limits
* pre: the number of seconds to include in epoch prior to burst start
* post: the number of seconds to include in epoch after burst start (this will include the rest of the burst window to account for potential differences in burst length
#### OPTIONAL INPUTS:
* adjust: a boolean determining if you would like to adjust for differences between TDT stimulation signal and stimulation artifact in the data (defaults to false)
* adj_by: a round double stating the number of samples you want to use toadjust for differences between TDT stimulation signal and stimulation artifact in the data, for instance if you would like this value to be the same across all runs. If adjust is set to true and no adj_by is specified, adj_by is calculated based on estimates of the stim artifact in the data
#### OUTPUTS:
* data_epoched: the data split into epochs (a time x channels x trials array)
* epoch_indices: the indices used to pull epochs from the given data, accounting for sampling rate differences and adjustment for lag
* adj_by: the number of samples used to adjust between TDT stimulation signal and stimulation artifact in the data

### pullStimPulses(): A wrapper for pullStimEpochs() to pull individual pulses within a single burst
#### REQUIRED INPUTS:
* data: data to be split into pulses (a time x channels array, NOT epoched)
* pulse_idx: the indices of each individual pulse within a burst (a trials x 1 cell array, each cell contains a pulses x 1 matrix, indexing is *not* within the burst but over the full time series), as generated by getStimIndices()
* fsData: the sampling rate of data
* fsSing: the sampling rate of the Sing TDT output that was used to generate pulse_idx
* pre: the number of seconds to include in epoch prior to pulse start
* post: the number of seconds to include in epoch after pulse start (this will include the rest of the burst window to account for potential differences in burst length
#### OPTIONAL INPUTS:
* adjust: a boolean determining if you would like to adjust for differences between TDT stimulation signal and stimulation artifact in the data (defaults to false)
* adj_by: a round double stating the number of samples you want to use toadjust for differences between TDT stimulation signal and stimulation artifact in the data, for instance if you would like this value to be the same across all runs. If adjust is set to true and no adj_by is specified, adj_by is calculated based on estimates of the stim artifact in the data
#### OUTPUTS:
* stim_pulses: the data surrounding each individual pulse, a trials x 1 cell array, with each cell containing a time x channels x pulses matrix
* adj_by: the number of samples used to adjust between TDT stimulation signal and stimulation artifact in the data for each trial, a  trials x 1 array
#### NOTES:
* this is not efficient code, but ensures that pulses are identified in the correct burst and in a way that should flexibly accomodate bursts with different numbers of stimulation pulses (only briefly tested the latter)
* if only one pulse per burst, just use pullStimEpochs (the only difference is the output format of the data)

